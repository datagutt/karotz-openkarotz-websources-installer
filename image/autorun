#!/bin/bash
# ---------------------------------------------------------------------------
# 
# Karotz Auto Update script WIFI configuration
# 
# Author: Rodolphe Franceschi <rodolphe.franceschi@gmail.com>
# 
# Under MIT License 
# @ see http://opensource.org/licenses/MIT
#
# ---------------------------------------------------------------------------

export HOME=/tmp
export GNUPGHOME=/tmp/

LED=/karotz/bin/led

function led_orange_pulse {
    # killall led
    $LED -l FFA500 -p 000000 -d 700 &
}

function led_red {
    killall led
    $LED -l ff0000
}

function led_green {
    killall led
    $LED -l 00ff00
}

function SAY {
    LD_LIBRARY_PATH=/tmp /tmp/madplay /tmp/$1.mp3 $2
}

function LOG {
    echo $1 >> /mnt/usbkey/logautorun.txt
}

function ERROR {
    LOG "$1" 
    sync
    killall musicloop.sh
    killall madplay
    SAY "Karotz_error"
    SAY "error"
    killall led
    /karotz/bin/led -l FF0000 -b 000000 &
    exit
}

# Unpack Tools
tar -xvf /mnt/usbkey/tools2.tar -C /tmp/

LD_LIBRARY_PATH=/tmp /tmp/madplay /mnt/usbkey/sound/Karotz_SFX_USB.mp3
cp -r /mnt/usbkey/sound/*.mp3 /tmp/
ls /tmp


if [ -f /mnt/usbkey/updatedone ]; then
    LOG "[USBKEY] ## UPDATE ALREADY DONE"
    exit 0
fi


cd $(dirname $0)

led_orange_pulse

# Installing
LOG "Installing"
bash /mnt/usbkey/openkarotz/install

LOG "GREEN"
led_green
sleep 2

LOG "[USBKEY] ## All done. Rebooting."
SAY "Karotz_SFX_OK"
SAY "maj_ok"
cd ..

LOG "TOUCHING"
touch /mnt/usbkey/updatedone
sleep 1

SAY "karotz_off"
echo  "::once:/sbin/reboot" >> /etc/inittab


